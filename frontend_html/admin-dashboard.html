<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quản trị - Sách Cũ Theo Khu Vực</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

  <div class="sidebar">
    <div class="logo-area">
      <img src="assets/images/logo.png" alt="Logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
      <span>ADMIN PANEL</span>
    </div>

    <nav>
      <a href="#" class="nav-link active">
        <i class="bi bi-grid-fill"></i> Tổng quan
      </a>
      <a href="admin-users.html" class="nav-link">
        <i class="bi bi-people-fill"></i> Quản lý người dùng
      </a>
      <a href="admin-posts.html" class="nav-link">
        <i class="bi bi-file-earmark-text-fill"></i> Duyệt bài đăng
      </a>
      <a href="admin-categories.html" class="nav-link">
        <i class="bi bi-tags-fill"></i> Quản lý thể loại
      </a>
    </nav>

    <div class="search-box">
      <div class="mb-2 text-uppercase text-secondary" style="font-size: 11px; font-weight: bold;">Tìm nhanh</div>
      <input type="text" placeholder="Tìm theo tên, email...">
    </div>
  </div>

  <div class="main-content">

    <div class="top-header">
      <div class="header-title">
        Quản trị - <span>Sách Cũ Theo Khu Vực</span>
      </div>
      <div class="d-flex gap-3 align-items-center">
        <span id="welcomeName" class="d-none d-md-block text-secondary small">Xin chào, Admin</span>
        <button id="logoutBtn" class="btn btn-sm btn-outline-danger">
          <i class="bi bi-box-arrow-right"></i> Đăng xuất
        </button>
      </div>
    </div>

    <div class="row g-4 mb-4">
      <div class="col-md-4">
        <div class="stat-card">
          <div class="stat-label">Người dùng</div>
          <div class="stat-value" id="countUser">...</div>
          <div class="stat-desc">Tổng tài khoản</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="stat-card">
          <div class="stat-label">Bài đăng</div>
          <div class="stat-value" id="countPost">...</div>
          <div class="stat-desc">Tổng bài đăng</div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="stat-card">
          <div class="stat-label">Chờ duyệt</div>
          <div class="stat-value highlight-warning" id="countPending">...</div>
          <div class="stat-desc">Cần xử lý</div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-md-8">
        <div class="chart-container">
          <h5 class="fw-bold mb-4" style="font-size: 16px;">Hoạt động tuần (bài đăng mới)</h5>
          <canvas id="weeklyChart"></canvas>
        </div>
      </div>

      <div class="col-md-4">
        <div class="ranking-card">
          <h5 class="fw-bold mb-3" style="font-size: 16px;">Top người đăng</h5>
          <ul class="ranking-list" id="topPostersList">
            <li class="text-center text-muted py-5">
                <div class="spinner-border text-warning spinner-border-sm" role="status"></div>
                <span class="ms-2">Đang tải...</span>
            </li>
          </ul>

          <div class="category-stat">
            <h6 class="fw-bold mb-2" style="font-size: 14px;">Thể loại nổi bật</h6>
            <div class="d-flex justify-content-between mb-1" style="font-size: 13px;">
              <span id="topCatName">Đang tính toán...</span>
              <span id="topCatPercent">0%</span>
            </div>
            <div class="progress">
              <div class="progress-bar" id="topCatBar" role="progressbar" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script src="assets/js/api.js"></script>
  <script>
    // ==========================================
    // 1. KIỂM TRA QUYỀN ADMIN
    // ==========================================
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    if (!user || user.role !== "ADMIN") {
      window.location.href = "loginAdmin.html";
    } else {
        const welcomeEl = document.getElementById("welcomeName");
        if(welcomeEl) welcomeEl.innerText = "Xin chào, " + (user.name || "Admin");
    }

    // Logout logic
    document.getElementById("logoutBtn").addEventListener("click", () => {
      if (window.api && window.api.authAPI) window.api.authAPI.logout();
      else { localStorage.removeItem("authToken"); localStorage.removeItem("user"); }
      window.location.href = "loginAdmin.html";
    });

    // ==========================================
    // 2. LOGIC DASHBOARD
    // ==========================================

    document.addEventListener('DOMContentLoaded', loadData);

    async function loadData() {
      try {
        // Gọi API lấy users và posts song song
        const [users, posts] = await Promise.all([
          window.api.adminAPI.listUsers(),
          window.api.adminAPI.getAllPosts()
        ]);

        // --- A. CẬP NHẬT THỐNG KÊ (CARDS) ---
        document.getElementById('countUser').textContent = users.length.toLocaleString();
        document.getElementById('countPost').textContent = posts.length.toLocaleString();

        // Đếm bài chờ duyệt (PENDING)
        const pendingCount = posts.filter(p => {
          const s = (p.status || p.postStatus || "").toUpperCase();
          return s === 'PENDING';
        }).length;
        document.getElementById('countPending').textContent = pendingCount;

        // --- B. VẼ BIỂU ĐỒ (CHART.JS) ---
        renderWeeklyChart(posts);

        // --- C. XẾP HẠNG (TOP POSTERS) ---
        renderTopPosters(posts);

        // --- D. THỂ LOẠI NỔI BẬT ---
        renderTopCategory(posts);

      } catch (error) {
        console.error("Lỗi Dashboard:", error);
        document.getElementById('topPostersList').innerHTML = `<li class="text-danger text-center">Lỗi tải dữ liệu</li>`;
      }
    }

    // HÀM XỬ LÝ BIỂU ĐỒ
    function renderWeeklyChart(posts) {
      const labels = [];
      const dataCounts = [0, 0, 0, 0, 0, 0, 0];
      const today = new Date();

      for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(today.getDate() - i);
        labels.push(`${d.getDate()}/${d.getMonth() + 1}`);
      }

      posts.forEach(p => {
        const dStr = p.created_at || p.createdAt;
        if (!dStr) return;
        const pDate = new Date(dStr);
        // Nếu bài đăng trong vòng 7 ngày
        const dayKey = `${pDate.getDate()}/${pDate.getMonth() + 1}`;
        const index = labels.indexOf(dayKey);
        if (index !== -1) {
          dataCounts[index]++;
        }
      });

      const ctx = document.getElementById('weeklyChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Bài đăng mới',
            data: dataCounts,
            borderColor: '#e67e22',
            backgroundColor: 'rgba(230, 126, 34, 0.1)',
            borderWidth: 2,
            tension: 0.4,
            fill: true,
            pointBackgroundColor: '#fff',
            pointBorderColor: '#e67e22',
            pointRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, grid: { borderDash: [5, 5] }, ticks: { stepSize: 1 } },
            x: { grid: { display: false } }
          }
        }
      });
    }

    // HÀM XỬ LÝ TOP NGƯỜI ĐĂNG
    function renderTopPosters(posts) {
      const userCounts = {};

      posts.forEach(p => {
        let name = "Ẩn danh";
        if (p.user && p.user.name) name = p.user.name;
        else if (p.userName) name = p.userName;

        if (userCounts[name]) userCounts[name]++;
        else userCounts[name] = 1;
      });

      const sortedUsers = Object.entries(userCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);

      const listEl = document.getElementById('topPostersList');
      listEl.innerHTML = "";

      if (sortedUsers.length === 0) {
        listEl.innerHTML = "<li class='text-center'>Chưa có dữ liệu</li>";
        return;
      }

      sortedUsers.forEach((item, index) => {
        const userName = item[0];
        const count = item[1];
        listEl.innerHTML += `
            <li class="ranking-item">
                <span class="ranking-name">${index + 1}. ${userName}</span>
                <span class="ranking-count">${count} bài</span>
            </li>
        `;
      });
    }

    // HÀM XỬ LÝ THỂ LOẠI NỔI BẬT
    function renderTopCategory(posts) {
      const catCounts = {};
      let totalCategorized = 0;

      posts.forEach(p => {
        const catName = p.categoryName || (p.book ? p.book.category : null) || "Khác";
        if (catCounts[catName]) catCounts[catName]++;
        else catCounts[catName] = 1;
        totalCategorized++;
      });

      const sortedCats = Object.entries(catCounts).sort((a, b) => b[1] - a[1]);

      if (sortedCats.length > 0) {
        const topName = sortedCats[0][0];
        const topCount = sortedCats[0][1];
        const percent = totalCategorized > 0 ? Math.round((topCount / totalCategorized) * 100) : 0;

        document.getElementById('topCatName').innerText = topName;
        document.getElementById('topCatPercent').innerText = `${percent}%`;
        document.getElementById('topCatBar').style.width = `${percent}%`;
      } else {
        document.getElementById('topCatName').innerText = "Chưa có dữ liệu";
      }
    }
  </script>
</body>
</html>